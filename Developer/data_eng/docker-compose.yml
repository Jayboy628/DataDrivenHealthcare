version: '3'

services:

######################################################
# DATABASE SERVICE
######################################################
  postgres:
    image: postgres:latest
    build: './docker/postgres'
    restart: always
    container_name: postgres
    logging:
      driver: "json-file"
      options:
          max-file: "5"
          max-size: "10m"
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=airflow
      - POSTGRES_PASSWORD=airflow
      - POSTGRES_DB=airflow_db
      - AWS_CONFIG_FILE=/opt/airflow/.aws/config
      - AWS_SHARED_CREDENTIALS_FILE=/opt/airflow/.aws/credentials
    healthcheck:
      test: [ "CMD", "pg_isready", "-q", "-d", "airflow_db", "-U", "airflow" ]
      timeout: 45s
      interval: 10s
      retries: 10
    volumes:
          - postgres-data:/var/lib/postgresql/data # Add this line to persist PostgreSQL data

######################################################
# AIRFLOW
######################################################

  airflow:
      build: ./docker/airflow
      restart: always
      container_name: airflow
      volumes:
        - ./mnt/airflow/airflow.cfg:/opt/airflow/airflow.cfg
        - ./mnt/airflow/dags:/opt/airflow/dags
        - ~/.aws:/opt/airflow/.aws
        - /Users/shaunjaybrown/.dbt:/opt/airflow/.dbt
        - /Users/shaunjaybrown/projects/repo/DataDrivenHealthcare:/app
      ports:
        - 8080:8080
      environment:
        - PYTHONPATH=/opt/airflow/dags
        - AWS_CONFIG_FILE=/opt/airflow/.aws/config
        - AWS_SHARED_CREDENTIALS_FILE=/opt/airflow/.aws/credentials
        - AIRFLOW_CONN_SNOWFLAKE_DEFAULT={"conn_type":"snowflake","login":"rayboy","password":"@Password78!","schema":"external_stages",
          "extra":{"account":"xub44819","database":"MANAGE_DB","region":"us-east-1","warehouse":"healthcare_wh","role":"accountadmin"}}
      command: /opt/airflow/start-airflow.sh  # Added this line
      healthcheck:
        test: [ "CMD", "nc", "-z", "airflow", "8080" ]
        timeout: 45s
        interval: 10s
        retries: 10

######################################################
# NETWORK
######################################################

# Change name of default network otherwise URI invalid for HIVE
# because of the _ contained by default network
networks:
  default:
    name: airflow-network
# Define the named volume here
volumes:
  postgres-data: